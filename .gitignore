import Result from '#features/shared/result.js';

export default class FeeCaseGetByCifUseCase {
  async execute({ cif }, feeManagementModel, customerModel) {
    const [errCustomer, responseCustomer] = await customerModel.getCustomerDetailsByCif(cif);
    if (errCustomer) {
      return Result.fail({ message: "It's not possible to get address cif" });
    }

    const customerData = responseCustomer?.data?.customer || {};
    const [errFee, responseFee] = await feeManagementModel.getFeeByAccount(customerData);
    if (errFee) {
      return Result.fail({ message: "It's not possible to get fee values" });
    }

    const feesData = responseFee?.data || {};

    // Mapeando currentFees
    const currentFees = [
      ...(customerData?.customerCurrentFees?.map(x => ({
        feeDescription: x.feeDescription || '',
        feeCode: x.feeCode || ''
      })) || []),
      ...(feesData?.currentFees || [])
    ];

    // Mapeando fees
    const fees = [
      ...(customerData?.customerAccount?.map(fee => ({
        name: fee.feeGroup === 1 ? "Client Current Fees" : "Standard Fees",
        visible: true,
        kycMailingStatus: fee.kycMailingStatus,
        code: fee.feeGroup,
        accountNumber: fee.ddaNumber,
        cif: fee.cifno,
        fields: [
          {
            code: fee.feeCode,
            name: fee.feeDescription,
            defaultValue: fee.feeAmount,
            isStandard: fee.isFeesStandard === "Yes",
            isException: fee.isFeesStandard === "No",
            isCurrentClient: false,
            labelValue: `$${fee.feeAmount.toFixed(2)}`,
            tooltip: "",
            exceptionOptions: [],
            createdAt: "",
            updatedAt: "",
            id: "",
          }
        ]
      })) || []),
      ...(feesData?.fees || [])
    ];

    const result = {
      customerName: customerData?.customerAddress?.name || responseFee?.customerName || '',
      customerShortName: responseFee?.customerShortName || '',
      customerAddress: customerData?.customerAddress?.address || '',
      customerAccountOfficer: customerData?.customerAddress?.officer || '',
      cif: customerData?.customerAddress?.cif || cif,
      officerId: responseFee?.officerId || '',
      branchCity: responseFee?.branchCity || '',
      branchState: responseFee?.branchState || '',
      feePackage: responseFee?.feePackage || '',
      defaultFeePackageId: responseFee?.defaultFeePackageId || '',
      fees,
      feesActives: responseFee?.feesActives || [],
      documentUrl: responseFee?.documentUrl || '',
      currentFees
    };

    return Result.ok(result);
  }
}
