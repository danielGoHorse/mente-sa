import { Fee } from '#src/models/entities/Fees.js'
import Result from '#features/shared/result.js'
import CustomerFees from '#src/models/CustomerFees.js'
import BankAccountFee from '#src/models/BankAccountFee.js'
import InvestimentAccountFee from '#src/models/InvestimentAccountFee.js'
import { FeeCase } from '#src/models/entities/FeeCase.js'
import { Field } from '#src/models/entities/Fields.js'

export default class FeeGetByCifUseCase {
  async execute({ customerAccount }) {
   // global.logger.info('FeeGetByCifUseCase()')

    const result = { fees: [] }
    const fees = await this.#getFeeStandard([
      {
        feeType: 'Customer Fees'
      },
      {
        feeType: 'Bank Account Fees'
      },
      {
        feeType: 'Investment Account Fees'
      }
    ])

    const customer = new CustomerFees(fees, customerAccount)
    if (customer.fee) result.fees.push(customer.fee)
   // global.logger.info('After Customer Fees')
    const bank = new BankAccountFee(fees, customerAccount)
    if (bank.fee) result.fees.push(bank.fee)
   // global.logger.info('After Bank Account Fees')
    const equityField = await Field.find({ code: 7 })
    const investiment = new InvestimentAccountFee(
      fees,
      customerAccount,
      equityField[0]
    )
    if (investiment.fee?.feeGroups) result.fees.push(investiment.fee)
   // global.logger.info('After Investment Account Fees')
    const feesActives = await FeeCase.find({
      cif: customerAccount[0].cifno,
      status: {
        $nin: ['DONE', 'REJECTED']
      },
      caseNumber: {
        $exists: true
      }
    })
   // global.logger.info('After Fees Actives')
    result.feesActives = feesActives?.map((x) => ({
      caseNumber: x.caseNumber,
      id: x.id
    }))

    result.documentUrl =
      'https://minio-ui.dev.k8s.safra.int/api/v1/buckets/jarvis-public/objects/download?preview=true&prefix=U2NoZWR1bGVPZkZlZXMucGRm'

   // global.logger.info(`documentUrl= ${result.document}`)

    return Result.ok(result)
  }

  async #getFeeStandard(filter) {
   // global.logger.info('getFeeStandard()')

    const feeResult = []

    for await (const fee of Fee.find({
      $or: filter
    }).select({
      feeType: 1,
      feeGroups: {
        name: 1,
        fields: 1,
        code: 1
      }
    })) {
      feeResult.push(fee.toObject())
    }

    return feeResult
  }
}



_id
6468f46eff51aa9d77d849ee
feeType
"Customer Fees"

feeGroups
Array (3)

0
Object

1
Object
name
"Client Current Fees"
code
1

fields
Array (2)
visible
true
_id
6468f46eff51aa9d77d849de
createdAt
2023-05-20T16:25:31.436+00:00
updatedAt
2023-05-20T16:25:31.436+00:00

2
Object
name
"Exception Request"
code
1

fields
Array (2)
visible
true
_id
6468f46eff51aa9d77d849e7
createdAt
2023-05-20T16:25:31.436+00:00
updatedAt
2023-05-20T16:25:31.436+00:00
createdAt
2023-05-20T16:25:31.444+00:00
updatedAt
2023-05-20T16:25:31.444+00:00
__v
0
_id
6468f46eff51aa9d77d84a1b
feeType
"Bank Account Fees"

feeGroups
Array (3)

0
Object
name
"Standard Fees"
code
2

fields
Array (2)
visible
true
_id
6468f46eff51aa9d77d849fe
createdAt
2023-05-20T16:25:31.436+00:00
updatedAt
2023-05-20T16:25:31.436+00:00

1
Object
name
"Client Current Fees"
code
2

fields
Array (2)
visible
true
_id
6468f46eff51aa9d77d84a03
createdAt
2023-05-20T16:25:31.437+00:00
updatedAt
2023-05-20T16:25:31.437+00:00

2
Object
name
"Exception Request"
code
2

fields
Array (2)
visible
true
_id
6468f46eff51aa9d77d84a10
createdAt
2023-05-20T16:25:31.437+00:00
updatedAt
2023-05-20T16:25:31.437+00:00
createdAt
2023-05-20T16:25:31.444+00:00
updatedAt
2023-05-20T16:25:31.444+00:00
__v
0
_id
6468f46eff51aa9d77d84a56
feeType
"Investment Account Fees"

feeGroups
Array (3)

0
Object
name
"Standard Fees"
code
3

fields
Array (3)

0
Object
code
6
isException
false
name
"Safekeeping-Custody"
defaultValue
"A021"
tooltip
"Charged: Quarterly"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a2d
createdAt
2023-05-20T16:25:31.437+00:00
updatedAt
2023-05-20T16:25:31.437+00:00
isCurrentClient
false
isStandard
true

1
Object
code
5
isException
false
name
"SSL Account Maintenance"
defaultValue
"375"
tooltip
"Charged: Quarterly"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a2e
createdAt
2023-05-20T16:25:31.437+00:00
updatedAt
2023-05-20T16:25:31.437+00:00
isCurrentClient
false
isStandard
true

2
Object
code
7
isException
false
name
"Equity and Options Commission"
tooltip
"Charged: Per Trade"
defaultValue
"E3"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a2f
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00
isCurrentClient
false
isStandard
true
visible
true
_id
6468f46eff51aa9d77d84a30
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00

1
Object
name
"Client Current Fees"
code
3

fields
Array (3)

0
Object
code
6
isException
false
name
"Safekeeping-Custody"
defaultValue
"A021"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a34
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00
isCurrentClient
true
isStandard
false

1
Object
code
5
isException
false
name
"SSL Account Maintenance"
defaultValue
"375"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a35
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00
isCurrentClient
true
isStandard
false

2
Object
code
7
isException
false
name
"Equity and Options Commission"
defaultValue
"E3"

exceptionOptions
Array (empty)
_id
6468f46eff51aa9d77d84a36
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00
isCurrentClient
true
isStandard
false
visible
true
_id
6468f46eff51aa9d77d84a37
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00

2
Object
name
"Exception Request"
code
3

fields
Array (3)

0
Object
code
6
isException
true
name
"Safekeeping-Custody"
defaultValue
""

exceptionOptions
Array (99)

0
Object
text
"A032 - 0.50% per year with a minimum of $375.00 per quarter"
value
"A032"
visible
true
retired
false
approvedByDoubleA
true

1
Object

2
Object

3
Object

4
Object

5
Object

6
Object

7
Object

8
Object

9
Object

10
Object

11
Object

12
Object

13
Object

14
Object

15
Object

16
Object

17
Object

18
Object

19
Object

20
Object

21
Object

22
Object

23
Object

24
Object
Show 74 more fields in exceptionOptions
_id
6468f46eff51aa9d77d84a3b
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2023-05-20T16:25:31.438+00:00
isCurrentClient
false
isStandard
false

1
Object

2
Object
visible
true
_id
6468f46eff51aa9d77d84a48
createdAt
2023-05-20T16:25:31.438+00:00
updatedAt
2024-11-16T12:30:04.294+00:00
createdAt
2023-05-20T16:25:31.445+00:00
updatedAt
2024-11-16T12:30:04.295+00:00
__v
1




