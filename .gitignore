import Result from '#features/shared/result.js'

export default class FeeCaseGetByCifUseCase {
  async execute({ cif }, feeManagementModel, customerModel) {
    global.logger.info(`customerModel.getCustomerDetailsByCif(${cif})`)

    const [errCustomer, responseCustomer] = await customerModel.getCustomerDetailsByCif(cif)

    if (errCustomer) {
      return Result.fail({ message: "It's not possible to get address cif" })
    }

    const customerData = responseCustomer?.data?.customer || {}

    global.logger.info('feeManagementModel.getFeeByAccount')
    const [errFee, responseFee] = await feeManagementModel.getFeeByAccount(customerData)

    if (errFee) {
      return Result.fail({ message: "It's not possible to get fee values" })
    }

    const feesData = responseFee?.data || {}

    const currentFees = customerData?.customerCurrentFees?.map((x) => ({
      feeDescription: x.feeDescription,
      feeCode: x.feeCode
    })) || []

    const result = {
      customerName: customerData?.customerAddress?.name || '',
      customerShortName: customerData?.customerAddress?.shortName || '',
      customerAddress: customerData?.customerAddress?.address || '',
      customerAccountOfficer: customerData?.customerAddress?.officer || '',
      cif: customerData?.customerAddress?.cif || cif, 
      officerId: customerData?.customerAddress?.officerId || '',
      branchCity: customerData?.customerAddress?.branchCity || '',
      branchState: customerData?.customerAddress?.branchState || '',
      feePackage: customerData?.customerAddress?.feePackage || '',
      defaultFeePackageId: customerData?.customerAddress?.defaultFeePackageId || '',

      fees: feesData.fees || [],
      feesActives: feesData.feesActives || [],

      documentUrl: feesData.documentUrl || '',

      currentFees
    }

    global.logger.info('End process')

    return Result.ok(result)
  }
}

