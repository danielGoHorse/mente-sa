export async function executeStoreProcedure(connection, query, parameters = {}) {
  try {
    const request = connection.request();

    for (const key of Object.keys(parameters)) {
      request.input(key, parameters[key]);
    }

    const { recordset } = await request.execute(query);
    
    // Fechar a conexão pode ser feito aqui, se for o caso, mas cuidado se estiver reutilizando a conexão
    await mssql.close();

    if (recordset?.length === 0) return [];
    return recordset;
  } catch (error) {
    global.logger.error(`Erro na execução da procedure ${query}: ${error.message}`, error);
    // Dependendo da estratégia, pode-se optar por lançar o erro ou retornar um valor padrão.
    throw error;
  }
}
