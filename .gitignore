import mssql from 'mssql'

export async function connectToFeeMgmtDb() {
  const { ...props } = global.environment.sqlserver
  
  const config = {
    ...props,
    options: {
      encrypt: false,
      trustServerCertificate: true
    }
  }
  await mssql.close()

  return mssql.connect(config)
}

export async function executeStoreProcedure(connection, query, parameters = {}) {
  const request = connection.request()

  for (const key of Object.keys(parameters)) {
    request.input(key, parameters[key])
  }

  const { recordset } = await request.execute(query)

  await mssql.close()

  if (recordset?.length === 0) return []

  return recordset
}

  const query = 'sp_get_feegroupinfo';
    const parameters = { group_id: 1 }; // Opcional: omitir group_id para trazer todos
    const result = await executeStoreProcedure(connection, query, parameters);
    global.logger.info('Procedure Result:', result);

 global.logger.error('Failed to connect to SQL Server:', err.message);

   global.logger.info('Connected to SQL Server successfully.');
