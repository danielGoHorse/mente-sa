import numberToCurrency from '../core/helpers/currency.js';

export default class CustomerFees {
  #feeName = 'Customer Fees';
  #customer = {};
  #accounts = [];
  #clientCurrent = [];

  constructor(fees, accounts) {
    if (!fees || !Array.isArray(fees) || fees.length === 0) {
      throw new Error('Fees is empty or undefined');
    }

    // Seleciona o objeto correspondente a Customer Fees
    this.#customer = fees.filter((x) => x.feeType === this.#feeName)[0];
    if (!this.#customer || !Array.isArray(this.#customer.feeGroups)) {
      throw new Error('Customer Fees or feeGroups are undefined');
    }

    // Processa cada grupo, filtrando as exceptionOptions para remover as que estão retiradas
    this.#customer.feeGroups.forEach((feeGroup) => {
      feeGroup.fields?.forEach((item) => {
        item.exceptionOptions = item.exceptionOptions?.filter((x) => !x.retired) || [];
      });
    });

    // Filtra as contas relacionadas aos Customer Fees (usando o código do primeiro feeGroup)
    this.#accounts = accounts.filter(
      (x) => x.feeGroup === this.#customer.feeGroups[0].code
    );

    // Define o kycMailingStatus do primeiro grupo (Standard Fees) com base na conta do Bank (feeType === 2)
    this.#customer.feeGroups[0].kycMailingStatus =
      accounts.find((account) => account.feeType === 2)?.kycMailingStatus || null;

    // Atualiza os valores de label do grupo Standard Fees
    this.#customer.feeGroups[0].fields.forEach((field) => {
      field.labelValue = numberToCurrency(field.defaultValue);
    });

    // Processa o grupo Client Current Fees (o segundo grupo)
    if (this.#customer.feeGroups.length > 1) {
      this.#clientCurrent = this.#customer.feeGroups[1].fields;
      this.#configureCustomer();
    } else {
      console.warn('Client Current group is missing');
    }

    // Para o grupo Exceptions Request (terceiro grupo), copia os labelValues do grupo Client Current
    if (this.#customer.feeGroups.length > 2) {
      this.#customer.feeGroups[2].fields.forEach((field) => {
        field.labelValue =
          this.#customer.feeGroups[1]?.fields.find((f) => f.code === field.code)?.labelValue || '';
      });
    } else {
      console.warn('Exception group is missing');
    }
  }

  get fee() {
    return this.#customer;
  }

  /**
   * Configura os valores dos fields do grupo Client Current Fees, aplicando a regra "NOT APPLICABLE":
   * Se o campo (por exemplo, com código 2) vier vazio ou 0 e o kycMailingStatus do grupo Standard for diferente de "Hold Mail",
   * define o valor e label como "NOT APPLICABLE" e atualiza as exceptionOptions.
   */
  #configureCustomer() {
    if (this.#accounts.length < 1) {
      this.#customer = {};
      return;
    }

    for (const field of this.#clientCurrent) {
      for (const account of this.#accounts) {
        if (field.isCurrentClient && field.code === account.feeType) {
          // Regra NOT APPLICABLE: Para o campo com código 2 (Hold Mail Fee)
          // Se o valor estiver vazio ou for "0" e o kycMailingStatus do grupo Standard for diferente de "Hold Mail",
          // o valor será "NOT APPLICABLE"
          if (
            field.code === 2 &&
            (!account.feeAmount || account.feeAmount.toString() === '0') &&
            this.#customer.feeGroups[0].kycMailingStatus !== 'Hold Mail'
          ) {
            field.defaultValue = 'NOT APPLICABLE';
            field.labelValue = field.defaultValue;
            field.exceptionOptions = [
              {
                value: field.defaultValue,
                text: field.defaultValue
              }
            ];
          } else {
            field.defaultValue = account.feeAmount?.toString() || '';
            field.labelValue = numberToCurrency(field.defaultValue);
          }
        }
      }
    }

    // Atualiza informações comuns em todos os grupos com os dados da primeira conta
    for (const feeGroup of this.#customer.feeGroups) {
      feeGroup.cif = this.#accounts[0]?.cifno || null;
      feeGroup.accountNumber = this.#accounts[0]?.ddaNumber || null;
    }

    this.#clearMemory();
  }

  #clearMemory() {
    this.#accounts = [];
    this.#clientCurrent = [];
  }
}
