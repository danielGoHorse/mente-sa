Chat, legal, voltou....

SÃ³ preciso de mais uma ajuda....Da uma checada, nos nomes que eu estou chamando no banco certrinho e que o conductor esta esperando la, pois

Agora foram os atributos corretos, mas uns campos ficaram vazio....

import { FeeCase } from '#src/models/entities/FeeCase.js'
import Result from '#features/shared/result.js'
import {
  connectToFeeMgmtDb,
  executeStoreProcedure
} from '#core/data/mssql/index.js'

export default class FeeGetByCifUseCase {
  async execute({ customerAccount }) {
    global.logger.info('FeeGetByCifUseCase()')

    const cifno = customerAccount[0].cifno

    const feesData = await this.#getFeesFromSQL(cifno)

    if (!feesData.length) {
      return Result.fail({ message: "No data found for this CIF" })
    }

    const feePackageId = feesData[0]['Default Fee Package Id'] || null

    const exceptionData = feePackageId
      ? await this.#getExceptionFeesFromSQL(feePackageId)
      : []

    const result = {
      cif: cifno,
      customerName: feesData[0].CustomerName || '', 
      customerShortName: feesData[0].CustomerShortName || '', 
      customerAddress: feesData[0].CustomerAddress || '',
      customerAccountOfficer: feesData[0].Officer || '',
      officerId: feesData[0].OfficerId || '',
      branchCity: feesData[0]['Branch City'] || '',
      branchState: feesData[0]['Branch State'] || '',
      feePackage: feesData[0]['Default Fee Package'] || '',
      defaultFeePackageId: feesData[0]['Default Fee Package Id'] || '',
      fees: this.#mapFeesByCategory(feesData, exceptionData),
      feesActives: await this.#getActiveFees(cifno),
      documentUrl: this.#getDocumentUrl(feePackageId),
      currentFees: this.#mapCurrentFees(feesData)
    }

    return Result.ok(result)
  }

  async #getFeesFromSQL(cifno) {
    global.logger.info('getFeesFromSQL()')
    const connection = await connectToFeeMgmtDb()
    const recordset = await executeStoreProcedure(connection, 'sp_get_fees_byCIF', { cifno })
    return recordset
  }

  async #getExceptionFeesFromSQL(feePackageId) {
    global.logger.info('getExceptionFeesFromSQL()')
    const connection = await connectToFeeMgmtDb()
    const recordset = await executeStoreProcedure(connection, 'sp_get_exception_fees_bypackage', { feePackageId })
    return recordset
  }

  async #getActiveFees(cifno) {
    const feesActives = await FeeCase.find({
      cif: cifno,
      status: { $nin: ['DONE', 'REJECTED'] },
      caseNumber: { $exists: true }
    })

    return feesActives.map((x) => ({
      caseNumber: x.caseNumber,
      id: x.id
    }))
  }

  #mapFeesByCategory(feesData, exceptionData) {
    const mappedFees = []

    feesData.forEach(record => {
      const isException = record.StandardException === 'Exception'
      const isCurrentClient = record.FeeAmount > 0

      const field = {
        code: record.FeeCode,
        name: record.FeeDescription,
        defaultValue: record['Default Fee Amount'] || '',
        isStandard: !isException,
        isException: isException,
        isCurrentClient: isCurrentClient,
        labelValue: record.FeeAmount ? `$${record.FeeAmount}.00` : '',
        frequency: record.Frequency || '',
        defaultFrequency: record['Default Frequency'] || '',
        amount: record.FeeAmount || record['Default Fee Amount'] || 0,
        exceptionOptions: isException ? this.#parseExceptionOptions(exceptionData, record) : []
      }

      let feeGroup = mappedFees.find(f => f.feeType === record.FeeType)
      if (!feeGroup) {
        feeGroup = { feeType: record.FeeType, feeGroups: [] }
        mappedFees.push(feeGroup)
      }

      let targetGroup
      if (isException) {
        targetGroup = feeGroup.feeGroups.find(g => g.name === 'Exception Request')
        if (!targetGroup) {
          targetGroup = { name: 'Exception Request', fields: [] }
          feeGroup.feeGroups.push(targetGroup)
        }
      } else if (isCurrentClient) {
        targetGroup = feeGroup.feeGroups.find(g => g.name === 'Client Current Fees')
        if (!targetGroup) {
          targetGroup = { name: 'Client Current Fees', fields: [] }
          feeGroup.feeGroups.push(targetGroup)
        }
      } else {
        targetGroup = feeGroup.feeGroups.find(g => g.name === 'Standard Fees')
        if (!targetGroup) {
          targetGroup = { name: 'Standard Fees', fields: [] }
          feeGroup.feeGroups.push(targetGroup)
        }
      }

      targetGroup.fields.push(field)
    })

    return mappedFees
  }

  #parseExceptionOptions(exceptionData, record) {
    return exceptionData
      .filter(exc => exc.FeeCode === record.FeeCode)
      .map(exc => ({
        value: exc.Amount,
        text: `$${exc.Amount}.00`,
        visible: true,
        retired: false
      }))
  }

  #getDocumentUrl(feePackageId) {
    const scheduleUrls = global.environment.scheduleUrls
    const packageMap = {
      1: 'intlPB3',
      2: 'uSPBIndividual3',
      3: 'uSPBCorporation3',
      4: 'efraPB3',
      5: 'eraPB3'
    }

    const scheduleType = packageMap[feePackageId] || ''
    
    return scheduleUrls[scheduleType] || ''
  }

  #mapCurrentFees(feesData) {
    return feesData
      .filter(record => record.FeeAmount > 0)
      .map(record => ({
        feeDescription: `${record.FeeDescription} - $${record.FeeAmount}.00`,
        feeCode: `${record.FeeType} ${record.ACCTNO}`
      }))
  }
}

_______________________

Aqui como esta o conductor:

import Result from '#features/shared/result.js'

export default class FeeCaseGetByCifUseCase {
  async execute({ cif }, feeManagementModel, customerModel) {
    global.logger.info(`customerModel.getCustomerDetailsByCif(${cif})`)

    const [errCustomer, responseCustomer] = await customerModel.getCustomerDetailsByCif(cif)

    if (errCustomer) {
      return Result.fail({ message: "It's not possible to get address cif" })
    }

    const customerData = responseCustomer?.data?.customer || {}

    global.logger.info('feeManagementModel.getFeeByAccount')
    const [errFee, responseFee] = await feeManagementModel.getFeeByAccount(customerData)

    if (errFee) {
      return Result.fail({ message: "It's not possible to get fee values" })
    }

    const feesData = responseFee?.data || {}

    const currentFees = customerData?.customerCurrentFees?.map((x) => ({
      feeDescription: x.feeDescription,
      feeCode: x.feeCode
    })) || []

    const result = {
      customerName: customerData?.customerAddress?.name || '',
      customerShortName: customerData?.customerAddress?.shortName || '',
      customerAddress: customerData?.customerAddress?.address || '',
      customerAccountOfficer: customerData?.customerAddress?.officer || '',
      cif: customerData?.customerAddress?.cif || cif, 
      officerId: customerData?.customerAddress?.officerId || '',
      branchCity: customerData?.customerAddress?.branchCity || '',
      branchState: customerData?.customerAddress?.branchState || '',
      feePackage: customerData?.customerAddress?.feePackage || '',
      defaultFeePackageId: customerData?.customerAddress?.defaultFeePackageId || '',

      fees: feesData.fees || [],
      feesActives: feesData.feesActives || [],

      documentUrl: feesData.documentUrl || '',

      currentFees
    }

    global.logger.info('End process')

    return Result.ok(result)
  }
}


E aqui como chegou a chamada:

{
    "code": 200,
    "data": {
        "customerName": "FRANCO JACK",
        "customerShortName": "",
        "customerAddress": "JACK FRANCO 425 EAST 58TH STREET APT # 48 B NEW YORK NY 10022",
        "customerAccountOfficer": "036 Sigalit Levy-Shabi        BR 4",
        "cif": "F016583",
        "officerId": "",
        "branchCity": "",
        "branchState": "",
        "feePackage": "",
        "defaultFeePackageId": "",
        "fees": [
            {
                "feeType": "Client Fees",
                "feeGroups": [
                    {
                        "name": "Client Current Fees",
                        "fields": [
                            {
                                "code": "JH001",
                                "name": "Account Maintenance Fee",
                                "defaultValue": 25,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$25.00",
                                "frequency": "Monthly - Charged Quarterly",
                                "defaultFrequency": "Monthly - Charged Quarterly",
                                "amount": 25,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH001",
                                "name": "Account Maintenance Fee",
                                "defaultValue": 25,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$25.00",
                                "frequency": "Monthly - Charged Quarterly",
                                "defaultFrequency": "Monthly - Charged Quarterly",
                                "amount": 25,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH001",
                                "name": "Account Maintenance Fee",
                                "defaultValue": 25,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$25.00",
                                "frequency": "Monthly - Charged Quarterly",
                                "defaultFrequency": "Monthly - Charged Quarterly",
                                "amount": 25,
                                "exceptionOptions": []
                            }
                        ]
                    },
                    {
                        "name": "Standard Fees",
                        "fields": [
                            {
                                "code": "JH002",
                                "name": "Hold Mail Fee",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "Annual - Charged Annual",
                                "defaultFrequency": "Annual - Charged Annual",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH002",
                                "name": "Hold Mail Fee",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "Annual - Charged Annual",
                                "defaultFrequency": "Annual - Charged Annual",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH002",
                                "name": "Hold Mail Fee",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "Annual - Charged Annual",
                                "defaultFrequency": "Annual - Charged Annual",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH002",
                                "name": "Hold Mail Fee",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "Annual - Charged Annual",
                                "defaultFrequency": "Annual - Charged Annual",
                                "amount": 0,
                                "exceptionOptions": []
                            }
                        ]
                    },
                    {
                        "name": "Exception Request",
                        "fields": [
                            {
                                "code": "JH001",
                                "name": "Account Maintenance Fee",
                                "defaultValue": 25,
                                "isStandard": false,
                                "isException": true,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "",
                                "defaultFrequency": "Monthly - Charged Quarterly",
                                "amount": 25,
                                "exceptionOptions": [
                                    {
                                        "value": 0,
                                        "text": "$0.00",
                                        "visible": true,
                                        "retired": false
                                    }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                "feeType": "Bank Account Fees",
                "feeGroups": [
                    {
                        "name": "Client Current Fees",
                        "fields": [
                            {
                                "code": "JH006",
                                "name": "FX Outgoing Wire Fee",
                                "defaultValue": 25,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$25.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 25,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH007",
                                "name": "FX Outgoing Wire (SafraLink) Fee",
                                "defaultValue": 10,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$10.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 10,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH007",
                                "name": "FX Outgoing Wire (SafraLink) Fee",
                                "defaultValue": 10,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$10.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 10,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH007",
                                "name": "FX Outgoing Wire (SafraLink) Fee",
                                "defaultValue": 10,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$10.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 10,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH006",
                                "name": "FX Outgoing Wire Fee",
                                "defaultValue": 25,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$25.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 25,
                                "exceptionOptions": []
                            },
                            {
                                "code": "JH007",
                                "name": "FX Outgoing Wire (SafraLink) Fee",
                                "defaultValue": 10,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$10.00",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 10,
                                "exceptionOptions": []
                            }
                        ]
                    },
                    {
                        "name": "Exception Request",
                        "fields": [
                            {
                                "code": "JH006",
                                "name": "FX Outgoing Wire Fee",
                                "defaultValue": 25,
                                "isStandard": false,
                                "isException": true,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 25,
                                "exceptionOptions": [
                                    {
                                        "value": 0,
                                        "text": "$0.00",
                                        "visible": true,
                                        "retired": false
                                    }
                                ]
                            },
                            {
                                "code": "JH006",
                                "name": "FX Outgoing Wire Fee",
                                "defaultValue": 25,
                                "isStandard": false,
                                "isException": true,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "",
                                "defaultFrequency": "",
                                "amount": 25,
                                "exceptionOptions": [
                                    {
                                        "value": 0,
                                        "text": "$0.00",
                                        "visible": true,
                                        "retired": false
                                    }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                "feeType": "Individual Fees",
                "feeGroups": [
                    {
                        "name": "Standard Fees",
                        "fields": [
                            {
                                "code": "BPS002",
                                "name": "Safekeeping of Securities",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "0.35% /YR min $375.00/QTR",
                                "defaultFrequency": "0.35% /YR min $375.00/QTR",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS004",
                                "name": "US Equities Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS005",
                                "name": "Options Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS002",
                                "name": "Safekeeping of Securities",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "0.35% /YR min $375.00/QTR",
                                "defaultFrequency": "0.35% /YR min $375.00/QTR",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS004",
                                "name": "US Equities Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS005",
                                "name": "Options Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS002",
                                "name": "Safekeeping of Securities",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "0.35% /YR min $375.00/QTR",
                                "defaultFrequency": "0.35% /YR min $375.00/QTR",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS004",
                                "name": "US Equities Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS005",
                                "name": "Options Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS002",
                                "name": "Safekeeping of Securities",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "0.35% /YR min $375.00/QTR",
                                "defaultFrequency": "0.35% /YR min $375.00/QTR",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS004",
                                "name": "US Equities Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS005",
                                "name": "Options Commission",
                                "defaultValue": "",
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": false,
                                "labelValue": "",
                                "frequency": "$0.10 per share, min charge of $150 per trade",
                                "defaultFrequency": "$0.10 per share, min charge of $150 per trade",
                                "amount": 0,
                                "exceptionOptions": []
                            }
                        ]
                    },
                    {
                        "name": "Client Current Fees",
                        "fields": [
                            {
                                "code": "BPS003",
                                "name": "SSL Account Maintanance Fee",
                                "defaultValue": 375,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$375.00",
                                "frequency": "Quarterly on Day 1",
                                "defaultFrequency": "Quarterly on Day 1",
                                "amount": 375,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS003",
                                "name": "SSL Account Maintanance Fee",
                                "defaultValue": 375,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$375.00",
                                "frequency": "Quarterly on Day 1",
                                "defaultFrequency": "Quarterly on Day 1",
                                "amount": 375,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS003",
                                "name": "SSL Account Maintanance Fee",
                                "defaultValue": 375,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$375.00",
                                "frequency": "Quarterly on Day 1",
                                "defaultFrequency": "Quarterly on Day 1",
                                "amount": 375,
                                "exceptionOptions": []
                            },
                            {
                                "code": "BPS003",
                                "name": "SSL Account Maintanance Fee",
                                "defaultValue": 375,
                                "isStandard": true,
                                "isException": false,
                                "isCurrentClient": true,
                                "labelValue": "$375.00",
                                "frequency": "Quarterly on Day 1",
                                "defaultFrequency": "Quarterly on Day 1",
                                "amount": 375,
                                "exceptionOptions": []
                            }
                        ]
                    }
                ]
            }
        ],
        "feesActives": [],
        "documentUrl": "https://minio-ui.dev.k8s.safra.int/api/v1/buckets/conductor-public/objects/download?preview=true&prefix=U2NoZWR1bGVvZkZlZXNVU1BCSW5kaXZpZHVhbDMucGRm&version_id=null",
        "currentFees": [
            {
                "feeDescription": "Hold Mail Fee (per annum) -  $0.00",
                "feeCode": " Personal Checking -D 7113617"
            },
            {
                "feeDescription": "USD/FX Outgoing Wire Fee $75.00",
                "feeCode": " Personal Checking -D 7113617"
            },
            {
                "feeDescription": "USD/FX Outgoing Wire Fee $75.00",
                "feeCode": " Personal Checking -D 7115342"
            },
            {
                "feeDescription": "USD/FX Outgoing Wire Fee $75.00",
                "feeCode": " Personal Promise   D 7115431"
            },
            {
                "feeDescription": "Account Maintenance Fee $1,200 (S/A $600) -  $0.00",
                "feeCode": " Personal Savings 7115822"
            },
            {
                "feeDescription": "USD/FX Outgoing Wire Fee $75.00",
                "feeCode": " Personal Savings 7115822"
            }
        ]
    }
}

-------------------------------------------------------

Aqui como esta testando apenas local no meu /fee

"code": 200,
    "data": {
        "cif": "F016583",
        "customerName": "",
        "customerAddress": "",
        "customerAccountOfficer": "Mordekhai Aghai           BR 7",
        "officerId": "369   ",
        "branchCity": "New York",
        "branchState": "NY",
        "feePackage": "Domestic Individual",
        "defaultFeePackageId": 2,
        "fees": [
            {
                "feeType": "Individual Fees",
                "feeGroups": [
