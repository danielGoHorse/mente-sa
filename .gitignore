import Result from '#features/shared/result.js'

export default class FeeCaseGetByCifUseCase {
  async execute({ cif }, feeManagementModel, customerModel) {
    global.logger.info(`customerModel.getCustomerDetailsByCif(${cif})`)
    const [errCustomer, responseCustomer] =
      await customerModel.getCustomerDetailsByCif(cif)

    if (errCustomer) {
      return Result.fail({ message: "It's not possible to get address cif" })
    }
    global.logger.info('feeManagementModel.getFeeByAccount')
    const [errFee, responseFee] = await feeManagementModel.getFeeByAccount(
      responseCustomer.data.customer
    )

    if (errFee) {
      return Result.fail({ message: "Its's not possible get fee values" })
    }

    const currentFees =
      responseCustomer?.data?.customer?.customerCurrentFees?.map((x) => ({
        feeDescription: x.feeDescription,
        feeCode: x.feeCode
      }))

    const result = {
      customerName: responseCustomer.data.customer.customerAddress.name,
      customerAddress: responseCustomer.data.customer.customerAddress.address,
      customerAccountOfficer:
        responseCustomer.data.customer.customerAddress.officer,
      cif: responseCustomer.data.customer.customerAddress.cif,
      branchCity: responseFee.data.accounts[0].branchCity,
      branchState: responseFee.data.accounts[0].branchState,
      branchType: responseFee.data.accounts[0].branchType,
      packageType: responseFee.data.accounts[0].defaultPackageType,
      packageName: responseFee.data.accounts[0].feePackage,
      defaultFeePackageId: responseFee.data.accounts[0].defaultFeePackageId,
      fees: responseFee.data.fees,
      feesActives: responseFee.data.feesActives,
      documentUrl: responseFee.data.accounts[0].documentUrl,
      currentFees
    }
    global.logger.info('End process')
    return Result.ok(result)
  }
}
