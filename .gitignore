export async function executeStoreProcedure(connection, query, parameters = {}) {
  try {
    const request = connection.request();

    for (const key of Object.keys(parameters)) {
      request.input(key, parameters[key]);
    }

    global.logger.info(`Executando procedure ${query} com parâmetros: ${JSON.stringify(parameters)}`);

    const result = await request.execute(query);
    global.logger.info(`Resultado da procedure ${query}: ${JSON.stringify(result)}`);

    // Fechar a conexão aqui pode impactar se outras operações usarem a mesma conexão
    await mssql.close();

    if (!result.recordset || result.recordset.length === 0) {
      // Se não há recordset, você pode optar por retornar um valor padrão indicando sucesso.
      return { success: true };
    }

    return result.recordset;
  } catch (error) {
    global.logger.error(`Erro na execução da procedure ${query}: ${error.message}`, error);
    throw error;
  }
}
