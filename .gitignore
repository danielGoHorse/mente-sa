import mssql from 'mssql'

export async function connectToFeeMgmtDb() {
  const { ...props } = global.environment.sqlserver
  
  const config = {
    ...props,
    options: {
      encrypt: false,
      trustServerCertificate: true
    }
  }
  await mssql.close()

  return mssql.connect(config)
}

export async function executeStoreProcedure(connection, query, parameters = {}) {
  try {
    const request = connection.request();

    for (const key of Object.keys(parameters)) {
      request.input(key, parameters[key]);
    }

    //global.logger.info(`Executando procedure ${query} com parâmetros: ${JSON.stringify(parameters)}`);

    const result = await request.execute(query);
    //global.logger.info(`Resultado da procedure ${query}: ${JSON.stringify(result)}`);

    await mssql.close();

    if (!result.recordset || result.recordset.length === 0) {
      return { success: true };
    }

    return result.recordset;
  } catch (error) {
    global.logger.error(`Erro na execução da procedure ${query}: ${error.message}`, error);
    throw error;
  }
}




>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>



const conn = await connectToFeeMgmtDb();
let pkgData = {};
let stdRows  = [];
let excRows  = [];

try {
  /* pacote / dados de agência */
  [pkgData] = await executeStoreProcedure(conn, 'sp_get_fees_byCIF', {
    cifno: customerAccount[0].cifno
  });

  const packageId = pkgData?.['Default Fee Package Id'];
  if (packageId) {
    stdRows = await executeStoreProcedure(
      conn, 'sp_get_standard_fees_bypackage', { FeePackageId: packageId }
    );
    excRows = await executeStoreProcedure(
      conn, 'sp_get_exception_fees_bypackage', { FeePackageId: packageId }
    );
    console.log('STD rows', stdRows);
    console.log('EXC rows', excRows);
  }
} finally {
  await conn.close();        // fecha UMA única vez
}

