import { UploadedDocument } from "@/app/store/types";
import api from "@/app/api";

// ...

useEffect(() => {
  async function hydrateDocs() {
    if (!data?.documents?.content?.length) return;

    // Evita reprocessar
    if (documentList.length) return;

    const paths: string[] = data.documents.content;

    async function getLinks(serverPath: string) {
      const res = await api.get("/v1/file/link", {
        params: {
          application: "conductor-client",
          path: serverPath,
        },
      });
      const { url, urlPreview } = res.data.data;
      return { url, urlPreview };
    }

    const docs: UploadedDocument[] = await Promise.all(
      paths.map(async (p) => {
        const [uuid, ...rest] = p.split("/");
        const name = rest.join("/");

        const { url, urlPreview } = await getLinks(p);

        return {
          serverPath: p,
          serverUrlSigned: url,
          documentURLPreview: urlPreview,
          documentName: name,
          documentUUID: uuid,
          createdAt: data.createdAt ?? new Date().toISOString(),
          uploadedBy: { fullName: data.createdBy, userId: data.createdBy },
          documentStatus: "uploaded",
        };
      })
    );

    setDocumentList(docs);
  }

  hydrateDocs();
}, [data, documentList.length, setDocumentList]);
